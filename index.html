<!DOCTYPE html>
<html>
<head>
    <title>wok</title>
<link href="tipsy.css" rel="stylesheet" type="text/css" /> 

    <style type="text/css">
    </style>
</head>
<body>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="js/jquery.tipsy.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<div id = "thing"></div>

<script type="text/javascript">
var svg;
var eachEntry;
var xScale;
var years = []
var uniqueYears;
var journalTypes = [];
var authors = [];
var uniqueTypes;
var goSecond = false;
var totals = [];
var huh = [];
var total1 = 0;
var total2 = 0;
var total3 = 0;
var total4 = 0;
var total5 = 0;
var total6 = 0;
var totalss = {};
var color =  d3.scale.category20c();
var opacityMap;
var firstLoadVar;
var firstLoad = -1;
var secLoad = -1;
var secondLoadVar;
var secondLoad = -1;


var thisTotal;
var totalsCircles;
var textsAre;
var heightScale;
var thisData = [];
    //Width and height
    var w = 1400;
    var h = 800;
    d3.csv("dMRI.csv", function(data) {
        thisData=(data);
        // console.log(data);
    for (i = 0;i<data.length; i++){ 
        years[i] = data[i].Year;
        authors[i] = data[i].Authors.split(".,");
        // journalTypes[i] = data[i].Authors;

        journalTypes[i] = data[i].Sourcetitle;
    } //generates an array of all Names



    function onlyUnique(value, index, self) { 
        return self.indexOf(value) === index;
    } 
    uniqueTypes = journalTypes.filter( onlyUnique ); //finds unique names
    // console.log("Unique Types: " + uniqueTypes);
    // uniqueTypes.split(".,")
    //split on names
    uniqueYears = years.filter( onlyUnique ); //finds unique names
    console.log("Unique Years: " + uniqueYears);

    function valueConsolidation(givenYear, i) { 
    //consolodates the Value for all values of a given Name
        var total = 0;
        for (i = 0;i<data.length; i++){ 
            if(data[i].Year == givenYear){
                total++;
            }else{
            }}
         return total;
     } 
    console.log("Sum of All 1996's: " + valueConsolidation("1996"))
 
    for (i = 0; i<uniqueYears.length; i++){
        totals[i]= valueConsolidation(uniqueYears[i])
    } //creates a new aray with the sums of all the different Names
    
    svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);
    
    var maxEntries = d3.max(totals, function(d) { return d; });

    xScale = d3.scale.linear()
        .domain([1984, 2014])
        .range([100, w-100]);

    var maxCited = d3.max(data, function(d) { return d.Cited; });
    opacityMap = d3.scale.linear()
        .domain([0, maxCited])
        .range([.2, 1])        

    heightScale = d3.scale.linear()
        .domain([0, maxEntries*3])
        .range([1, h-100]);


    totalsCircles = svg.selectAll("theseRects")  //draw circles with the newly parsed data values, the scale difference makes it weird!
        .data(data)
        .enter()
        .append("rect");
    totalsCircles
        .attr("class", function(d,i){
            for (j = 0; j<uniqueYears.length; j++){
                if (d.Year==uniqueYears[j]){
                    return "theseRects"+uniqueYears[j];               
                }
            }
        })
        .attr("x", function(d,i) {
            return  xScale(d.Year);
         })
        .attr("y", function(d,i){
                     //if your year matches the unique name year
                     //go through the unique name year's total at index of unique name
                     // map on the y region according to this
            for (j = 0; j<uniqueYears.length; j++){
                if (d.Year==uniqueYears[j]){
                    return (h/1.2-heightScale(totals[j]));               
                }
            }
            })
        .attr("width", 20)
        .attr("height", 2)
        .attr("stroke-width",1)
        .attr("fill", "none")
        .on("mouseover", function(d,i){
            thisAuthor = authors[i];
            console.log(thisAuthor)
            highlightAll(thisAuthor, i);
        })
        .on("mouseout", function(d,i){
            unhighlight();
        })


// var textsAre = svg.selectAll("textIs")
//     .data(data)
//     .enter()
//     .append("text")
//         .attr("class", function(d,i){
//             // for (j = 0; j<uniqueYears.length; j++){
//             //     if (d.Year==uniqueYears[j]){
//                     return "textIs"+i;               
//                 // }
//             // }
//         })
//         .attr("x", function(d,i) {
//             // console.log(d.Year)
//             return  xScale(d.Year);
//          })
//         .attr("y", function(d,i){
//                      //if your year matches the unique name year
//                      //go through the unique name year's total at index of unique name
//                      // map on the y region according to this
//             for (j = 0; j<uniqueYears.length; j++){
//                 if (d.Year==uniqueYears[j]){
//                     return (h/1.2-heightScale(totals[j]));               
//                 }
//                 else {
//                     return 10;
//                 }
//             }
//             });


function unhighlight(){
    // d3.selectAll("text.textIs")
    // .transition()
    // .attr("opacity",0)
    d3.selectAll("rect")
    .transition()
    // .attr("height", 10)
    .attr("stroke-width",1)
    .attr("stroke-opacity", function(d,i){
        return opacityMap(d.Cited);
    })       
    .attr("stroke", function(d,i){
        for (j=0; j<uniqueTypes.length; j++){
            if(d.Sourcetitle==uniqueTypes[j]){
               return color(j);
            }       
        }  
    })
}
function highlightAll(thisAuthor, index){
// for (b=0; b<years.length; b++){
d3.selectAll("rect")
    .transition()
    .attr("stroke-width",function(d,i){
     for (j=0; j<authors[i].length; j++){ 
        if(authors[i].length==='undefined'){
            return 1;
        }
        else{
        for (k=0; k<thisAuthor.length; k++){
         if(authors[i][j]==thisAuthor[k]){ 
            console.log(authors[i][j]+"  authorsatij  "+thisAuthor[k])
            return 8;
        }
        else {
            return 1;
        }            
        }
    }
    }
    })
    .attr("stroke",function(d,i){
     for (j=0; j<authors[i].length; j++){ 
        if(authors[i].length==='undefined'){
            return "white";
        }
        else{
        for (k=0; k<thisAuthor.length; k++){
         if(authors[i][j]==thisAuthor[k]){ 
            console.log(authors[i][j]+"  authorsatij  "+thisAuthor[k])
            return "black";
        }
        else {
            return "white";
        }            
        }
    }
    }
    })
    .attr("stroke-opacity",function(d,i){
     for (j=0; j<authors[i].length; j++){ 
        if(authors[i].length==='undefined'){
            return ".1";
        }
        else{
        for (k=0; k<thisAuthor.length; k++){
         if(authors[i][j]==thisAuthor[k]){ 
            console.log(authors[i][j]+"  authorsatij  "+thisAuthor[k])
            return "1";
        }
        else {
            return ".1";
        }            
        }
    }
    }
    })
    .each(moveToFront);

}

$('rect').tipsy({
    gravity: 'w', 
    html: true, 
    delayIn: 500, 
    title: function() {
        var d = this.__data__;     
        var whichCited;
        if (d.Cited>0){
            whichCited = d.Cited;
        } 
        else {
            whichCited = 0;
        }
        return d.Year+" "+", Journal: "+d.Sourcetitle+"<br/>Cited by "+whichCited+" other sources"+"<br/>Author: "+d.Authors;         
    }
});



firstLoadVar = setInterval(function(){ 
if(totals.length>0){    
    if (firstLoad<totals.length-1){
        firstLoad++; 
        if (firstLoad>=0){
            total1=0;

           agh(firstLoad, totals[firstLoad], uniqueYears[firstLoad]); //store inner subjects is the loading function for the big data      
        }
    }
    else {
        if(totals.length==10){
    makeRects();
}
        console.log(journalTypes.length)
    clearInterval(firstLoadVar); //and stop loading stuff in

    }
}
},100);  


        })

var moveToFront = function() { 
    this.parentNode.appendChild(this); 
}
// var color = d3.scale.linear()
//     .domain([0,15])
//     .range([d3.hsl(96, .6, 1), d3.hsl(276, .6, 0)])
    // .clamp(true);
// var color = d3.scale.cubehelix()
//     .domain([0, 14 / 2,14 - 1])
//     .range([d3.hsl(-40, 1, .4), d3.hsl(60, 1, 1), d3.hsl(160, 1, .4)]);
var theHeight = [];
function agh(z,tots, thisYear){
if(totals.length>0){    
d3.selectAll(".theseRects"+thisYear)
    .transition()
    .attr('y', function(d,i) {
        if (d.Year==thisYear){
            total1++;
             // return h/1.2-totals[j];               
            return (h/1.2)-heightScale(total1*3);   
            // theHeight.push((h/1.2)-heightScale(total1*3))                     
        }
    })
    .attr("fill", function(d,i){
        for (j=0; j<uniqueTypes.length; j++){
            if(d.Sourcetitle==uniqueTypes[j]){
               return color(j);
            }       
        }   
    })
    .attr("opacity", function(d,i){
        return opacityMap(d.Cited);
    })
    .attr("stroke-opacity", function(d,i){
        return opacityMap(d.Cited);
    })
    .attr("stroke", function(d,i){
        for (j=0; j<uniqueTypes.length; j++){
            if(d.Sourcetitle==uniqueTypes[j]){
               return color(j);
            }       
        }   
    })

// d3.selectAll(".textIs"+z)
//     .transition()
//     .attr('y', function(d,i) {
//         if (i==z){
//             total2++;
//            var thisGuy =  (h/1.2)-heightScale(total2*3);
//            if (thisGuy<0){
//             return thisGuy*-1;
//            }   
//            else {
//             return thisGuy;
//            }
//             // return theHeight[i];                  
//         }
//     })
//         .text(function(d,i){
//             for (j=0; j<authors[i].length; j++){ 
//             if(authors[i].length==='undefined'){
//             }
//             else{
//         // for (k=0; k<thisAuthor.length; k++){
//          // if(authors[i][j]==thisAuthor[k] && i!=index){ 
//                 return authors[i][j];
//             // console.log(authors[i][j]+"  authorsatij  "+thisAuthor[k])
//             // return 100;
//             }         
//         }
//     // }
//     // }            
//         })     
}
}

function makeRects(){
var otherData = d3.range(20);
svg.selectAll("otherRect")
.data(otherData)
.enter()
.append("circle")
.attr("class", "otherRect")
.attr("cx", 10)
.attr("cy", function(d,i){
    return i+10
})
.attr("r",10)
// .attr("height",10)
.attr("fill",function(d){
    return color(d);
})
//Add the SVG Text Element to the svgContainer

}
</script>
</body>
</html>